<!DOCTYPE html>
<html>
    <head>
        <title> Mathjax Markdown Editor </title>

        <!-- jquery -->
        <script type="text/javascript" src="./lib/jquery-1.11.2.min.js"></script>

        <!-- ace editor -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.8/ace.js" type="text/javascript" charset="utf-8"></script>

        <!-- jspdf -->
        <script type="text/javascript" src="./lib/jspdf.min.js"></script>

        <!-- marked -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>

        <script type="text/x-mathjax-config"> MathJax.Hub.Config(
            {tex2jax:
                {inlineMath:
                    [["$","$"], ["\\(","\\)"]]}
             /*, SVG: {
                 scale: 100
             }*/
             /*, jax: ["input/TeX","output/SVG"],
             SVG: {scale: 400}*/
             });
        </script>
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>

        <!-- mathjax_markdown -->
        <!--
        <script type="text/javascript" src="./mathjax_markdown.js"></script>
        -->

        <style type="text/css">
        #editor {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 50%;
            float: right
            width: 50%;
            padding: 50px;
        }
        #editor2{
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            float: left;
            width: 50%;
        }
        #wraper{
            position: absolute;
            right: 5%;
            top: 5%;
            color:white;
            z-index: 998;
            width: 85px;
        }
        /*#compile_btn{*/
        .my_button{
            z-index: 999;
            width: 80px;
            height: 30px;
            margin-top: 10px;
        }
        </style>
    </head>
    <body>
        <div id="editor">
        </div>
        <div id="editor2">
        </div>
        <div id="wraper">
            <button id="generate_pdf_btn" class="my_button">Generate PDF</button>
        </div>
    </body>

    <script>

        function generatePDF(){
            var pdf = new jsPDF('p', 'pt', 'letter')

            // source can be HTML-formatted string, or a reference
            // to an actual DOM element from which the text will be scraped.
            , source = $('#editor').get(0)

            // we support special element handlers. Register them with jQuery-style
            // ID selector for either ID or node name. ("#iAmID", "div", "span" etc.)
            // There is no support for any other type of selectors
            // (class, of compound) at this time.
            , specialElementHandlers = {
                // element with id of "bypass" - jQuery style selector
                /*'div to be rendered out': function(element, renderer){
                    // true = "handled elsewhere, bypass text extraction"
                    return true
                }*/
            }

            margins = {
                top: 80,
                bottom: 60,
                left: 40,
                width: 522
              };

            //if (!MathJax.isReady){
            //    console.log("MathJax not ready!");
            //}

            // Run this code after MathJax finishes rendering
            MathJax.Hub.Queue(function () {
                // all coords and widths are in jsPDF instance's declared units
                // 'inches' in this case
              pdf.fromHTML(
                    source // HTML string or DOM elem ref.
                    , margins.left // x coord
                    , margins.top // y coord
                    , {
                        'width': margins.width // max width of content on PDF
                        , 'elementHandlers': specialElementHandlers
                    },
                    function (dispose) {
                      // dispose: object with X, Y of the last line add to the PDF
                      //          this allow the insertion of new lines after html
                      pdf.save('preview.pdf');
                    },
                    margins
                )
            });
        }

        $(document).ready(function(){
            var markdown_editor = ace.edit("editor2");
            markdown_editor.setTheme("ace/theme/monokai");
            markdown_editor.getSession().setMode("ace/mode/markdown");

            markdown_editor.getSession().on("change", function(){
                var md_content = markdown_editor.getSession().getValue();
                var html_content = marked(md_content);
                // var parsed = $.parseHTML(html_content);
                $("#editor").html(html_content);

                // generate math
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, "editor"]);
            });

            // generate pdf
            $("#generate_pdf_btn").click(function(){
                generatePDF();
            });
        });

    </script>
</html>
